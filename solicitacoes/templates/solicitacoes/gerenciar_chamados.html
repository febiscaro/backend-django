{% extends "base.html" %}
{% load static %}

{% block content %}
    <div class="container py-4">

      
    <style>
      /* ===== Layout base ===== */
      .quad-title{font-weight:800;letter-spacing:.2px;margin:.75rem 0 1rem}
      .glass{
        border:0;border-radius:14px;box-shadow:0 10px 28px rgba(3,10,26,.12);
        background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.88));
        backdrop-filter:blur(3px);
      }

      /* ===== Cabe√ßalho das se√ß√µes ===== */
      .section-head{
        border-radius:12px;
        padding:.55rem .9rem;                   /* barra fina */
        display:flex; align-items:center; gap:.75rem;
        cursor:default; user-select:none;       /* n√£o parecer link */
        box-shadow: inset 0 -2px 0 rgba(0,0,0,.08);
        min-height:44px;
        flex-wrap:nowrap;                       /* n√£o quebrar */
        overflow:hidden;                        /* evita overflow lateral */
      }
      .section-head h3{
        font-size:1rem;font-weight:700;margin:0;
        /* <<< Fix principal: o t√≠tulo N√ÉO cresce para ‚Äúcomer‚Äù o contador */
        flex:0 1 auto;                          /* pode encolher, n√£o cresce */
        min-width:0;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      }
      .toggle-icon{transition:transform .25s ease}
      .collapsed .toggle-icon{transform:rotate(-90deg)}
      .section-head.expanded .toggle-icon{transform:rotate(0)}

      /* Contador colado ao t√≠tulo */
      .counter{
        font-weight:800;padding:.25rem .55rem;border-radius:999px;
        background:rgba(255,255,255,.2);
        display:inline-flex;align-items:center;gap:.35rem;
        margin-left:.5rem;                      /* espacinho depois do h3 */
      }
      .counter .num{font-variant-numeric:tabular-nums}
      .pulse{position:relative}
      .pulse::after{
        content:"";position:absolute;inset:-6px;border-radius:999px;opacity:.55;
        animation:pulse 1.6s ease-out infinite;box-shadow:0 0 0 0 currentColor;
      }
      @keyframes pulse{0%{opacity:.55;transform:scale(.9)}70%{opacity:0;transform:scale(1.35)}100%{opacity:0}}

      /* ===== A√ß√µes (select + bot√£o) ===== */
      .head-actions{
        margin-left:auto;                        /* empurra para a direita */
        display:flex; align-items:center; gap:.5rem;
        flex-wrap:nowrap; min-width:0;
      }
      .head-actions > *{ flex:0 0 auto }         /* nada cresce/estica */
      .head-actions .small{ white-space:nowrap } /* ‚ÄúPor p√°gina‚Äù numa linha s√≥ */
      .head-actions .form-select{
        /* corrige select 100% do Bootstrap dentro do flex */
        width:auto; min-width:4.6rem; max-width:8rem;
        height:34px; padding:.2rem 1.8rem .2rem .6rem; font-size:.9rem;
      }
      .btn-soft{
        border:0; border-radius:999px; background:rgba(255,255,255,.22);
        padding:.35rem .7rem; font-weight:600; white-space:nowrap;
      }

      /* Cores dos blocos */
      .abertos{background:#2f66ff;color:#fff}
      .andamento{background:#f2d270;color:#2b2b2b}
      .suspensos{background:#7e0010;color:#fff}
      .concluidos{background:#0aa39a;color:#fff}
      .cancelados{background:#343a40;color:#fff}

      .section-body{padding:0}
      .table td,.table th{vertical-align:middle}

      /* Chips de filtro */
      .filter-chip{
        display:inline-flex;align-items:center;gap:.35rem;margin:.15rem;
        background:#eef2ff;border-radius:999px;padding:.25rem .55rem;font-size:.875rem;
      }

      /* ===== BADGE ‚Äúnovas mensagens‚Äù (n√£o alterar tamanho) ===== */
      .badge-new{font-variant-numeric:tabular-nums; min-width:1.1rem; text-align:center;}
      .badge-new.badge-dot{
        width:.6rem;height:.6rem;padding:0!important;border-radius:9999px;
        display:inline-block; line-height:.6rem; vertical-align:middle;
      }

      /* ===== Normaliza√ß√£o de badges de STATUS (sem afetar .badge-new) ===== */
      .section-head .badge:not(.badge-new),
      .section-body .badge:not(.badge-new),
      .glass .badge:not(.badge-new){
        display:inline-flex; align-items:center; white-space:nowrap;
        line-height:1 !important;
        font-size:.80rem; padding:.25rem .55rem; border-radius:9999px;
        vertical-align:middle;
      }

      /* ===== Texto nunca vaza ===== */
      .text-break, .break-anywhere{ word-break:break-word; overflow-wrap:anywhere; }
      .glass .small{ overflow-wrap:anywhere; word-break:break-word; }

      /* Evita esticar o badge quando o t√≠tulo quebra */
      .glass .d-flex.justify-content-between{ align-items:center; }
      .glass .d-flex.justify-content-between .badge:not(.badge-new){ align-self:center; }

      /* ===== MOBILE ===== */
      @media (max-width:576px){
        .section-head{ padding:.48rem .6rem; min-height:40px; gap:.4rem; }

        /* Esconde ‚Äú+X novo(s)‚Äù para ganhar espa√ßo */
        .counter small{ display:none !important; }

        .head-actions{
          margin-left:auto;                     /* continua √† direita */
          gap:.28rem; min-width:0;
        }
        /* Esconde o label ‚ÄúPor p√°gina‚Äù */
        .head-actions .small{ display:none !important; }

        /* Select compacto e largura fixa */
        .head-actions .form-select{
          width:3.9rem; min-width:3.9rem; max-width:3.9rem;
          height:28px; font-size:.84rem;
          padding:.1rem .95rem .1rem .42rem;
        }

        /* Bot√£o com a mesma altura do select */
        .head-actions .btn-soft{
          display:inline-flex; align-items:center; justify-content:center;
          gap:.32rem; height:28px; line-height:1;
          padding:0 .5rem; font-size:.84rem; border-radius:999px;
        }
        .head-actions .btn-soft svg{ flex:0 0 auto; }

        /* Status pills levemente menores */
        .section-head .badge:not(.badge-new),
        .section-body .badge:not(.badge-new),
        .glass .badge:not(.badge-new){
          font-size:.78rem; padding:.20rem .48rem;
        }
      }

      /* Aparelhos MUITO estreitos: esconder o texto do bot√£o (deixa s√≥ o √≠cone) */
      @media (max-width:380px){
        .head-actions .btn-soft span{ display:none; }
      }
    </style>





  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 m-0">Tratativa de Chamados (Administrativo)</h1>
  </div>

  <!-- Filtros -->
  <form id="formFiltros" class="glass p-2 p-md-3 mb-3" method="get" action="{% url 'solicitacoes:gerenciar_chamados' %}">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <button class="btn btn-soft btn-sm d-flex align-items-center gap-2"
              type="button" data-bs-toggle="collapse" data-bs-target="#boxFiltros"
              aria-expanded="false" aria-controls="boxFiltros">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        Filtros
        <span id="badgeCountTipos" class="badge rounded-pill bg-primary ms-1">0</span>
      </button>

      <div class="ms-auto d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn-sm" type="button" id="btnLimparFiltros">Limpar</button>
        <button class="btn btn-primary btn-sm" type="submit">Aplicar</button>
      </div>
    </div>

    <div id="boxFiltros" class="collapse mt-3">
      <div class="row gy-2">
        <div class="col-12">
          <label class="form-label mb-2">Tipo</label>
          <div class="d-flex flex-wrap">
            {% for t in tipos %}
              <label class="filter-chip">
                <input class="chk-tipo" type="checkbox" name="tipo" value="{{ t.id }}" {% if t.id in tipo_ids %}checked{% endif %}>
                {{ t.nome }}
              </label>
            {% endfor %}
          </div>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">Criado de</label>
          <input type="date" name="criado_de" value="{{ criado_de }}" class="form-control form-control-sm">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">at√©</label>
          <input type="date" name="criado_ate" value="{{ criado_ate }}" class="form-control form-control-sm">
        </div>
      </div>
    </div>

    <div id="resumoFiltros" class="small text-muted mt-2 d-none">
      <span id="txtResumoTipos"></span>
      <span id="txtResumoDatas" class="ms-2"></span>
    </div>
  </form>

  {% with ca=counts.abertos|default:abertos.paginator.count cand=counts.andamento|default:andamento.paginator.count cs=counts.suspensos|default:suspensos.paginator.count cc=counts.concluidos|default:concluidos.paginator.count ck=counts.cancelados|default:cancelados.paginator.count %}
    <div class="d-flex flex-wrap gap-2 mb-3">
      <span class="badge rounded-pill bg-primary">Abertos {{ ca }}</span>
      <span class="badge rounded-pill bg-warning text-dark">Em andamento {{ cand }}</span>
      <span class="badge rounded-pill bg-danger">Suspensos {{ cs }}</span>
      <span class="badge rounded-pill bg-success">Conclu√≠dos {{ cc }}</span>
      <span class="badge rounded-pill bg-dark">Cancelados {{ ck }}</span>
    </div>
  {% endwith %}

  <!-- ===================== ATIVOS ===================== -->
  <h2 class="quad-title">Chamados Ativos</h2>

  <!-- Abertos -->
  <div class="glass mb-3">
    <div class="section-head abertos collapsed" data-bs-toggle="collapse" data-bs-target="#secAbertos" aria-expanded="false" id="headAbertos">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Abertos</h3>
      {% with n=novos.abertos|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ abertos.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por p√°gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_a }}&ps_a='+this.value">
          <option value="6"  {% if ps_a == 6 %}selected{% endif %}>6</option>
          <option value="10" {% if ps_a == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_a == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_a == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secAbertos">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secAbertos" class="collapse section-body" data-section-key="secAbertos">
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width:70px">#</th>
              <th>Tipo</th>
              <th>Solicitante</th>
              <th>Status</th>
              <th style="width:180px">Criado</th>
              <th>Tratativa</th>
              <th style="width:180px">Anexos</th>
              <th style="width:160px" class="text-center">A√ß√µes</th>
            </tr>
            </thead>
            <tbody>
            {% for c in abertos %}
              <tr data-chamado-id="{{ c.id }}">
                <td>
                  #{{ c.id }}
                  <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-d-{{ c.id }}"></span>
                </td>
                <td>{{ c.tipo.nome }}</td>
                <td>{{ c.solicitante|default:"‚Äî" }}</td>
                <td><span class="badge bg-primary">Aberto</span></td>
                <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
                <td class="text-break">{{ c.tratativa_adm|default:"‚Äî"|truncatechars:120 }}</td>
                <td>
                  {% with files=c.respostas.all %}
                    {% if files %}
                      {% for f in files %}
                        {% if f.valor_arquivo %}
                          <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">üìé {{ forloop.counter }}</a>
                        {% endif %}
                      {% endfor %}
                    {% else %}<span class="text-muted">‚Äî</span>{% endif %}
                  {% endwith %}
                  {% if c.anexo_adm %}
                    <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">üìé Anexo</a>
                  {% endif %}
                </td>
                <td class="text-center">
                  <form method="post" action="{% url 'solicitacoes:assumir_chamado' c.id %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-primary">Assumir</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="8" class="text-muted text-center">Nenhum chamado.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-md-none p-2">
        {% for c in abertos %}
          <div class="glass p-2 mb-2" data-chamado-id="{{ c.id }}">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-primary">Aberto</span>
            </div>
            <div class="small text-muted mt-1">
              #{{ c.id }}
              <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-m-{{ c.id }}"></span>
              ‚Ä¢ {{ c.criado_em|date:"d/m/Y H:i" }}
            </div>
            <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"‚Äî" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1 text-break"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            {% with files=c.respostas.all %}
              {% if files %}
                <div class="small mt-2">
                  <span class="text-muted">Anexos:</span>
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">üìé {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% if c.anexo_adm %}
              <div class="small mt-2">
                <span class="text-muted">Anexo da tratativa:</span>
                <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">üìé Abrir</a>
              </div>
            {% endif %}
            <form method="post" action="{% url 'solicitacoes:assumir_chamado' c.id %}" class="mt-2">
              {% csrf_token %}
              <button class="btn btn-sm btn-outline-primary w-100">Assumir</button>
            </form>
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>

      {% if abertos.paginator and abertos.paginator.num_pages > 1 %}
        <div class="px-3 py-2">
          <nav aria-label="Pagina√ß√£o ‚Äî Abertos">
            <ul class="pagination pagination-sm mb-0">
              {% if abertos.has_previous %}
                <li class="page-item"><a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ abertos.previous_page_number }}{% else %}?pg_a={{ abertos.previous_page_number }}{% endif %}">¬´</a></li>
              {% endif %}
              {% for i in abertos.paginator.page_range %}
                <li class="page-item {% if abertos.number == i %}active{% endif %}">
                  <a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ i }}{% else %}?pg_a={{ i }}{% endif %}">{{ i }}</a>
                </li>
              {% endfor %}
              {% if abertos.has_next %}
                <li class="page-item"><a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ abertos.next_page_number }}{% else %}?pg_a={{ abertos.next_page_number }}{% endif %}">¬ª</a></li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    </div>
  </div>

<!-- Em andamento -->
<div class="glass mb-3">
  <div class="section-head andamento collapsed" data-bs-toggle="collapse" data-bs-target="#secAnd" aria-expanded="false" id="headAnd">
    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
    <h3>Em andamento</h3>
    {% with n=novos.andamento|default:0 %}
    <span class="counter">
      <span class="num {% if n %}pulse{% endif %}">{{ andamento.paginator.count }}</span>
      {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
    </span>
    {% endwith %}
    <div class="head-actions">
      <span class="small opacity-75 d-none d-sm-inline">Por p√°gina</span>
      <select class="form-select form-select-sm" onchange="location.href='?{{ qs_and }}&ps_and='+this.value">
        <option value="2"  {% if ps_and == 2 %}selected{% endif %}>2</option>
        <option value="5"  {% if ps_and == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if ps_and == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if ps_and == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if ps_and == 20 %}selected{% endif %}>20</option>
      </select>
      <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secAnd">
        <span class="me-1">Ver mais</span>
        <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      </button>
    </div>
  </div>

  <div id="secAnd" class="collapse section-body" data-section-key="secAnd">
    <div class="table-responsive d-none d-md-block">
      <table class="table table-sm table-striped table-hover align-middle mb-0">
        <thead class="table-light">
        <tr>
          <th style="width:70px">#</th>
          <th>Tipo</th>
          <th>Solicitante</th>
          <th>Status</th>
          <th>Atendente</th>
          <th style="width:180px">Criado</th>
          <th>Tratativa</th>
          <th style="width:180px">Anexos</th>
          <th style="width:140px">Gerenciar</th>
        </tr>
        </thead>
        <tbody>
        {% for c in andamento %}
          <tr data-chamado-id="{{ c.id }}">
            <td>
              #{{ c.id }}
              <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-d-{{ c.id }}"></span>
            </td>
            <td>{{ c.tipo.nome }}</td>
            <td>{{ c.solicitante|default:"‚Äî" }}</td>
            <td><span class="badge bg-warning text-dark">Em andamento</span></td>
            <td>{{ c.atendente_nome|default:"‚Äî" }}</td>
            <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
            <td class="text-break">{{ c.tratativa_adm|default:"‚Äî"|truncatechars:120 }}</td>
            <td>
              {% with files=c.respostas.all %}
                {% if files %}
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">üìé {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                {% else %}<span class="text-muted">‚Äî</span>{% endif %}
              {% endwith %}
              {% if c.anexo_adm %}
                <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">üìé Tratativa</a>
              {% endif %}
            </td>
            <td>
              {% if c.pode_gerenciar %}
                <a href="{% url 'solicitacoes:chamado_tratativa' c.id %}" class="btn btn-sm btn-outline-primary">
                  Gerenciar
                </a>
              {% else %}
                <button class="btn btn-sm btn-outline-secondary" disabled
                        title="Em andamento por {{ c.atendente_nome|default:'‚Äî' }}">
                  Em andamento
                </button>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9" class="text-muted text-center">Nenhum chamado.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-md-none p-2">
      {% for c in andamento %}
        <div class="glass p-2 mb-2" data-chamado-id="{{ c.id }}">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">{{ c.tipo.nome }}</div>
            <span class="badge rounded-pill bg-warning text-dark">Em andamento</span>
          </div>
          <div class="small text-muted mt-1">
            #{{ c.id }}
            <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-m-{{ c.id }}"></span>
            ‚Ä¢ {{ c.criado_em|date:"d/m/Y H:i" }}
          </div>
          <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"‚Äî" }}</div>
          <div class="small mt-1"><span class="text-muted">Atendente:</span> {{ c.atendente_nome|default:"‚Äî" }}</div>
          {% if c.tratativa_adm %}<div class="small mt-1 text-break"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
          {% with files=c.respostas.all %}
            {% if files %}
              <div class="small mt-2">
                <span class="text-muted">Anexos:</span>
                {% for f in files %}
                  {% if f.valor_arquivo %}
                    <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">üìé {{ forloop.counter }}</a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          {% if c.anexo_adm %}
            <div class="small mt-2">
              <span class="text-muted">Anexo da tratativa:</span>
              <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">üìé Abrir</a>
            </div>
          {% endif %}

          {% if c.pode_gerenciar %}
            <a class="btn btn-sm btn-outline-primary w-100 mt-2"
               href="{% url 'solicitacoes:chamado_tratativa' c.id %}">Gerenciar</a>
          {% else %}
            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" disabled
                    title="Em andamento por {{ c.atendente_nome|default:'‚Äî' }}">
              Em andamento
            </button>
          {% endif %}
        </div>
      {% empty %}
        <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
      {% endfor %}
    </div>

    {% if andamento.paginator and andamento.paginator.num_pages > 1 %}
      <div class="px-3 py-2">
        <nav aria-label="Pagina√ß√£o ‚Äî Em andamento">
          <ul class="pagination pagination-sm mb-0">
            {% if andamento.has_previous %}
              <li class="page-item"><a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ andamento.previous_page_number }}{% else %}?pg_and={{ andamento.previous_page_number }}{% endif %}">¬´</a></li>
            {% endif %}
            {% for i in andamento.paginator.page_range %}
              <li class="page-item {% if andamento.number == i %}active{% endif %}">
                <a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ i }}{% else %}?pg_and={{ i }}{% endif %}">{{ i }}</a>
              </li>
            {% endfor %}
            {% if andamento.has_next %}
              <li class="page-item"><a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ andamento.next_page_number }}{% else %}?pg_and={{ andamento.next_page_number }}{% endif %}">¬ª</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</div>


  <!-- ===================== HIST√ìRICO ===================== -->
  <h2 class="quad-title">Hist√≥rico</h2>
<!-- Suspensos -->
<div class="glass mb-3">
  <div class="section-head suspensos collapsed" data-bs-toggle="collapse" data-bs-target="#secSus" aria-expanded="false" id="headSus">
    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
    <h3>Suspensos</h3>
    {% with n=novos.suspensos|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ suspensos.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
    {% endwith %}
    <div class="head-actions">
      <span class="small opacity-75 d-none d-sm-inline">Por p√°gina</span>
      <select class="form-select form-select-sm" onchange="location.href='?{{ qs_sus }}&ps_sus='+this.value">
        <option value="2"  {% if ps_sus == 2 %}selected{% endif %}>2</option>
        <option value="5"  {% if ps_sus == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if ps_sus == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if ps_sus == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if ps_sus == 20 %}selected{% endif %}>20</option>
      </select>
      <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secSus">
        <span class="me-1">Ver mais</span>
        <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      </button>
    </div>
  </div>

  <div id="secSus" class="collapse section-body" data-section-key="secSus">

    <!-- Desktop -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-sm table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>Tipo</th>
            <th>Solicitante</th>
            <th>Status</th>
            <th>Atendente</th>
            <th style="width:180px">Criado</th>
            <th>Tratativa</th>
            <th style="width:240px">Gerenciar</th>
          </tr>
        </thead>
        <tbody>
        {% for c in suspensos %}
          <tr data-chamado-id="{{ c.id }}">
            <td>
              #{{ c.id }}
              <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-d-{{ c.id }}"></span>
            </td>
            <td>{{ c.tipo.nome }}</td>
            <td>{{ c.solicitante|default:"‚Äî" }}</td>
            <td><span class="badge bg-danger">Suspenso</span></td>
            <td>{{ c.atendente_nome|default:"‚Äî" }}</td>
            <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
            <td class="text-break">{{ c.tratativa_adm|default:"‚Äî"|truncatechars:120 }}</td>

            <td class="text-center">
              <div class="d-flex gap-2 justify-content-center">
                <a href="{% url 'solicitacoes:chamado_tratativa' c.id %}" class="btn btn-sm btn-outline-primary">Gerenciar</a>

                {% if c.pode_reabrir %}
                  <form method="post" action="{% url 'solicitacoes:reabrir_chamado' c.id %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-success" onclick="return confirm('Reabrir este chamado?');">
                      Reabrir
                    </button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8" class="text-muted text-center">Nenhum chamado.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile -->
    <div class="d-md-none p-2">
      {% for c in suspensos %}
        <div class="glass p-2 mb-2" data-chamado-id="{{ c.id }}">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">{{ c.tipo.nome }}</div>
            <span class="badge rounded-pill bg-danger">Suspenso</span>
          </div>
          <div class="small text-muted mt-1">
            #{{ c.id }}
            <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-m-{{ c.id }}"></span>
            ‚Ä¢ {{ c.criado_em|date:"d/m/Y H:i" }}
          </div>
          <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"‚Äî" }}</div>
          <div class="small mt-1"><span class="text-muted">Atendente:</span> {{ c.atendente_nome|default:"‚Äî" }}</div>
          {% if c.tratativa_adm %}<div class="small mt-1 text-break"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}

          <div class="d-grid gap-2 mt-2">
            <a class="btn btn-sm btn-outline-primary w-100" href="{% url 'solicitacoes:chamado_tratativa' c.id %}">Gerenciar</a>

            {% if c.pode_reabrir %}
              <form method="post" action="{% url 'solicitacoes:reabrir_chamado' c.id %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-success w-100">Reabrir</button>
              </form>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
      {% endfor %}
    </div>

  </div>
</div>


  <!-- Conclu√≠dos -->
  <div class="glass mb-3">
    <div class="section-head concluidos collapsed" data-bs-toggle="collapse" data-bs-target="#secCon" aria-expanded="false" id="headCon">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Conclu√≠dos</h3>
      {% with n=novos.concluidos|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ concluidos.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por p√°gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_con }}&ps_con='+this.value">
          <option value="2"  {% if ps_con == 2 %}selected{% endif %}>2</option>
          <option value="5"  {% if ps_con == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if ps_con == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_con == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_con == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secCon">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secCon" class="collapse section-body" data-section-key="secCon">
      <div class="table-responsive d-none d-md-block">
        <table class="table table-sm table-striped table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>Tipo</th>
            <th>Solicitante</th>
            <th>Status</th>
            <th>Atendente</th>
            <th style="width:180px">Criado</th>
            <th>Tratativa</th>
            <th style="width:140px">Gerenciar</th>
          </tr>
          </thead>
          <tbody>
          {% for c in concluidos %}
            <tr data-chamado-id="{{ c.id }}">
              <td>
                #{{ c.id }}
                <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-d-{{ c.id }}"></span>
              </td>
              <td>{{ c.tipo.nome }}</td>
              <td>{{ c.solicitante|default:"‚Äî" }}</td>
              <td><span class="badge bg-success">Conclu√≠do</span></td>
              <td>{{ c.atendente_nome|default:"‚Äî" }}</td>
              <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
              <td class="text-break">{{ c.tratativa_adm|default:"‚Äî"|truncatechars:120 }}</td>
              <td><a href="{% url 'solicitacoes:chamado_tratativa' c.id %}" class="btn btn-sm btn-outline-primary">Gerenciar</a></td>
            </tr>
          {% empty %}
            <tr><td colspan="8" class="text-muted text-center">Nenhum chamado.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-md-none p-2">
        {% for c in concluidos %}
          <div class="glass p-2 mb-2" data-chamado-id="{{ c.id }}">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-success">Conclu√≠do</span>
            </div>
            <div class="small text-muted mt-1">
              #{{ c.id }}
              <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-m-{{ c.id }}"></span>
              ‚Ä¢ {{ c.criado_em|date:"d/m/Y H:i" }}
            </div>
            <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"‚Äî" }}</div>
            <div class="small mt-1"><span class="text-muted">Atendente:</span> {{ c.atendente_nome|default:"‚Äî" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1 text-break"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            <a class="btn btn-sm btn-outline-primary w-100 mt-2" href="{% url 'solicitacoes:chamado_tratativa' c.id %}">Gerenciar</a>
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Cancelados -->
  <div class="glass">
    <div class="section-head cancelados collapsed" data-bs-toggle="collapse" data-bs-target="#secCan" aria-expanded="false" id="headCan">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Cancelados</h3>
      {% with n=novos.cancelados|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ cancelados.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por p√°gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_can }}&ps_can='+this.value">
          <option value="2"  {% if ps_can == 2 %}selected{% endif %}>2</option>
          <option value="5"  {% if ps_can == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if ps_can == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_can == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_can == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secCan">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secCan" class="collapse section-body" data-section-key="secCan">
      <div class="table-responsive d-none d-md-block">
        <table class="table table-sm table-striped table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>Tipo</th>
            <th>Solicitante</th>
            <th>Status</th>
            <th>Atendente</th>
            <th style="width:180px">Criado</th>
            <th>Tratativa</th>
            <th style="width:140px">Gerenciar</th>
          </tr>
          </thead>
          <tbody>
          {% for c in cancelados %}
            <tr data-chamado-id="{{ c.id }}">
              <td>
                #{{ c.id }}
                <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-d-{{ c.id }}"></span>
              </td>
              <td>{{ c.tipo.nome }}</td>
              <td>{{ c.solicitante|default:"‚Äî" }}</td>
              <td><span class="badge bg-dark">Cancelado</span></td>
              <td>{{ c.atendente_nome|default:"‚Äî" }}</td>
              <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
              <td class="text-break">{{ c.tratativa_adm|default:"‚Äî"|truncatechars:120 }}</td>
              <td><a href="{% url 'solicitacoes:chamado_tratativa' c.id %}" class="btn btn-sm btn-outline-primary">Gerenciar</a></td>
            </tr>
          {% empty %}
            <tr><td colspan="8" class="text-muted text-center">Nenhum chamado.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-md-none p-2">
        {% for c in cancelados %}
          <div class="glass p-2 mb-2" data-chamado-id="{{ c.id }}">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-dark">Cancelado</span>
            </div>
            <div class="small text-muted mt-1">
              #{{ c.id }}
              <span class="badge badge-new bg-danger ms-1 d-none" id="m-new-m-{{ c.id }}"></span>
              ‚Ä¢ {{ c.criado_em|date:"d/m/Y H:i" }}
            </div>
            <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"‚Äî" }}</div>
            <div class="small mt-1"><span class="text-muted">Atendente:</span> {{ c.atendente_nome|default:"‚Äî" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1 text-break"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            <a class="btn btn-sm btn-outline-primary w-100 mt-2" href="{% url 'solicitacoes:chamado_tratativa' c.id %}">Gerenciar</a>
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
/* ================= CSRF ================= */
function getCookie(name){
  let v=null;
  if(document.cookie && document.cookie!==''){
    for(const c of document.cookie.split(';')){
      const t=c.trim();
      if(t.startsWith(name+'=')){ v=decodeURIComponent(t.substring(name.length+1)); break; }
    }
  }
  return v;
}
function getCsrfToken(){
  const c=getCookie('csrftoken');
  if(c && c.length>=32) return c;
  const i=document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
  return (i && i.length>=32) ? i : null;
}

/* =============== Memoriza estado + marca se√ß√£o vista =============== */
(function () {
  const hasBs = typeof window.bootstrap?.Collapse === 'function';
  const SEEN = { busy:false, sent:{} };
  function marcarVistoSecao(secao){
    if(!secao || SEEN.busy || SEEN.sent[secao]) return;
    const token=getCsrfToken(); if(!token) return;
    SEEN.busy=true;
    fetch("{% url 'solicitacoes:marcar_secao_vista' %}",{
      method:"POST", credentials:"same-origin",
      headers:{ "Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRFToken":token },
      body:"secao="+encodeURIComponent(secao)
    }).catch(()=>{}).finally(()=>{ SEEN.busy=false; SEEN.sent[secao]=true; });
  }

  document.querySelectorAll('.collapse.section-body').forEach(el=>{
    const secKey=el.dataset.sectionKey||el.id||'sec';
    const key='tratativa:'+secKey;
    const saved=localStorage.getItem(key);
    if(saved==='open' && hasBs){ try{ new bootstrap.Collapse(el,{toggle:true}); }catch(e){} }
    el.addEventListener('shown.bs.collapse', ()=>{
      localStorage.setItem(key,'open');
      document.querySelector('[data-bs-target="#'+el.id+'"]')?.classList.remove('collapsed');
      const map={secAbertos:"abertos",secAnd:"andamento",secSus:"suspensos",secCon:"concluidos",secCan:"cancelados"};
      marcarVistoSecao(map[secKey]);
    });
    el.addEventListener('hidden.bs.collapse', ()=>{
      localStorage.setItem(key,'closed');
      document.querySelector('[data-bs-target="#'+el.id+'"]')?.classList.add('collapsed');
    });
  });

/* ========== CLIQUE GUARDADO NA BARRA ==========
   Bloqueia o data-api do Bootstrap no cabe√ßalho: s√≥ abre/fecha
   ao clicar na pr√≥pria barra OU no bot√£o "Ver mais".
   Cliques nos controles (.head-actions) n√£o colapsam.
*/
document.querySelectorAll('.section-head[data-bs-target]').forEach(function(head){
  head.addEventListener('click', function(e){
    // Sempre barrar a propaga√ß√£o para o document (onde o BS faz o toggle)
    e.stopPropagation();

    const insideActions = !!e.target.closest('.head-actions');
    const isVerMais    = !!e.target.closest('.btn-soft');

    // Se clicou em controles da barra (exceto "Ver mais"): deixa funcionar e sai
    if (insideActions && !isVerMais) return;

    // Cabe√ßalho fora dos controles OU no "Ver mais" -> toggle manual
    const targetSel = head.getAttribute('data-bs-target') || head.dataset.bsTarget;
    const target    = document.querySelector(targetSel);
    if (!target) return;

    const inst = bootstrap.Collapse.getOrCreateInstance(target, { toggle:false });
    inst.toggle();
  }); // <- sem capture!
});

// Refor√ßo: qualquer elemento dentro de .head-actions (menos "Ver mais")
// tamb√©m bloqueia a propaga√ß√£o, por seguran√ßa.
document.querySelectorAll('.section-head .head-actions *:not(.btn-soft)').forEach(function(el){
  el.addEventListener('click', function(e){
    e.stopPropagation();
  });
});


/* =============== NOVAS MENSAGENS (poll) =============== */
(function(){
  const SEEN_URL = "{% url 'solicitacoes:atendimento_seen' %}";

  function getIds(){
    const ids = new Set();
    document.querySelectorAll('[data-chamado-id]').forEach(el=>{
      const id = el.getAttribute('data-chamado-id');
      if (id) ids.add(id);
    });
    return Array.from(ids);
  }

  function marcarChamadoVisto(id){
    const token=getCsrfToken(); if(!token) return;
    const body = new URLSearchParams({ids: String(id)});
    fetch(SEEN_URL, {
      method:"POST",
      credentials:"same-origin",
      headers:{ "Content-Type":"application/x-www-form-urlencoded; charset=UTF-8", "X-CSRFToken": token, "X-Requested-With":"XMLHttpRequest" },
      body
    }).catch(()=>{});
  }

  function setBadge(id, value){
    let isBool=false, n=0;
    if (typeof value === 'boolean' || value === 'true' || value === 'false'){
      isBool = (value === true || value === 'true'); n = isBool ? 1 : 0;
    } else {
      const parsed = parseInt(value, 10);
      n = isNaN(parsed) ? 0 : parsed;
    }
    ['m-new-d-'+id,'m-new-m-'+id].forEach(domId=>{
      const b = document.getElementById(domId);
      if(!b) return;
      if(n>0){
        if(isBool){ b.textContent=''; b.classList.add('badge-dot'); }
        else { b.textContent = n>9 ? '9+' : String(n); b.classList.remove('badge-dot'); }
        b.classList.remove('d-none');
      } else {
        b.textContent=''; b.classList.add('d-none'); b.classList.remove('badge-dot');
      }
    });
  }

  async function tick(){
    const ids = getIds();
    if(!ids.length) return;
    const qs = new URLSearchParams({ids: ids.join(',')});
    try{
      const r = await fetch("{% url 'solicitacoes:api_novas_mensagens' %}?"+qs.toString(), {credentials:'same-origin'});
      if(!r.ok) return;
      const data = await r.json();
      ids.forEach(id => setBadge(id, data[id]));
    }catch(_e){}
  }

  document.addEventListener('click', (ev)=>{
    const a = ev.target.closest('a[href]');
    if(!a) return;
    const row = a.closest('[data-chamado-id]');
    if(!row) return;
    const id = row.getAttribute('data-chamado-id');
    if(!id) return;
    if(a.href.includes('/solicitacoes/chamados/') || a.href.match(/chamado_tratativa/)){
      ['m-new-d-'+id,'m-new-m-'+id].forEach(domId=>{
        const b = document.getElementById(domId);
        if(b){ b.textContent=''; b.classList.add('d-none'); b.classList.remove('badge-dot'); }
      });
      marcarChamadoVisto(id);
    }
  });

  window.addEventListener('pageshow', tick);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tick(); });
  window.addEventListener('focus', tick);
  document.addEventListener('DOMContentLoaded', ()=>{ tick(); setInterval(tick, 20000); });
})();
</script>


{% endblock %}
