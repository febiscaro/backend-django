




{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <style>
    .quad-title{font-weight:800;letter-spacing:.2px;margin:.75rem 0 1rem}
    .glass{border:0;border-radius:14px;box-shadow:0 10px 28px rgba(3,10,26,.12);
           background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.88));
           backdrop-filter:blur(3px);}
    .section-head{border-radius:12px;padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;
                  cursor:pointer;user-select:none;box-shadow: inset 0 -2px 0 rgba(0,0,0,.08);flex-wrap:wrap;}
    .section-head h3{font-size:1rem;font-weight:700;margin:0}
    .head-actions{margin-left:auto;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .counter{font-weight:800;padding:.25rem .55rem;border-radius:999px;background:rgba(255,255,255,.2);
             display:inline-flex;align-items:center;gap:.35rem}
    .counter .num{font-variant-numeric:tabular-nums}
    .pulse{position:relative}
    .pulse::after{content:"";position:absolute;inset:-6px;border-radius:999px;opacity:.55;
                  animation:pulse 1.6s ease-out infinite;box-shadow:0 0 0 0 currentColor}
    @keyframes pulse{0%{opacity:.55;transform:scale(.9)}70%{opacity:0;transform:scale(1.35)}100%{opacity:0}}
    .abertos{background:#2f66ff;color:#fff}
    .andamento{background:#f2d270;color:#2b2b2b}
    .suspensos{background:#7e0010;color:#fff}
    .concluidos{background:#0aa39a;color:#fff}
    .cancelados{background:#343a40;color:#fff}
    .toggle-icon{transition:transform .25s ease}
    .collapsed .toggle-icon{transform:rotate(-90deg)}
    .btn-soft{border:0;border-radius:10px;background:rgba(255,255,255,.22);padding:.4rem .7rem;font-weight:600;white-space:nowrap}
    .section-body{padding:0}
    .table td,.table th{vertical-align:middle}
    .filter-chip{display:inline-flex;align-items:center;gap:.35rem;margin:.15rem;
                 background:#eef2ff;border-radius:999px;padding:.25rem .55rem;font-size:.875rem}
    @media (max-width:576px){
      .section-head{padding:.6rem .75rem}
      .head-actions .form-select-sm{display:none}
    }
  </style>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 m-0">Tratativa de Chamados (Administrativo)</h1>
  </div>

  {# Filtros #}
  <form id="formFiltros" class="glass p-2 p-md-3 mb-3" method="get" action="{% url 'solicitacoes:gerenciar_chamados' %}">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <button class="btn btn-soft btn-sm d-flex align-items-center gap-2"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#boxFiltros"
              aria-expanded="false"
              aria-controls="boxFiltros">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        Filtros
        <span id="badgeCountTipos" class="badge rounded-pill bg-primary ms-1">0</span>
      </button>

      <div class="ms-auto d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn-sm" type="button" id="btnLimparFiltros">Limpar</button>
        <button class="btn btn-primary btn-sm" type="submit">Aplicar</button>
      </div>
    </div>

    <div id="boxFiltros" class="collapse mt-3">
      <div class="row gy-2">
        <div class="col-12">
          <label class="form-label mb-2">Tipo</label>
          <div class="d-flex flex-wrap">
            {% for t in tipos %}
              <label class="filter-chip">
                <input class="chk-tipo" type="checkbox" name="tipo" value="{{ t.id }}" {% if t.id in tipo_ids %}checked{% endif %}>
                {{ t.nome }}
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label mb-1">Criado de</label>
          <input type="date" name="criado_de" value="{{ criado_de }}" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">atÃ©</label>
          <input type="date" name="criado_ate" value="{{ criado_ate }}" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
        </div>
      </div>
    </div>

    {# resumo visual rÃ¡pido quando fechado #}
    <div id="resumoFiltros" class="small text-muted mt-2 d-none">
      <span id="txtResumoTipos"></span>
      <span id="txtResumoDatas" class="ms-2"></span>
    </div>
  </form>


  {% with ca=counts.abertos|default:abertos.paginator.count cand=counts.andamento|default:andamento.paginator.count cs=counts.suspensos|default:suspensos.paginator.count cc=counts.concluidos|default:concluidos.paginator.count ck=counts.cancelados|default:cancelados.paginator.count %}
    <div class="d-flex flex-wrap gap-2 mb-3">
      <span class="badge rounded-pill bg-primary">Abertos {{ ca }}</span>
      <span class="badge rounded-pill bg-warning text-dark">Em andamento {{ cand }}</span>
      <span class="badge rounded-pill bg-danger">Suspensos {{ cs }}</span>
      <span class="badge rounded-pill bg-success">ConcluÃ­dos {{ cc }}</span>
      <span class="badge rounded-pill bg-dark">Cancelados {{ ck }}</span>
    </div>
  {% endwith %}

  <!-- ===================== QUADRANTE SUPERIOR ===================== -->
  <h2 class="quad-title">Chamados Ativos</h2>

  {# ---------- Abertos ---------- #}
  <div class="glass mb-3">
    <div class="section-head abertos collapsed" data-bs-toggle="collapse" data-bs-target="#secAbertos" aria-expanded="false" id="headAbertos">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Abertos</h3>
      {% with n=novos.abertos|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ abertos.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por pÃ¡gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_a }}&ps_a='+this.value">
          <option value="6"  {% if ps_a == 6 %}selected{% endif %}>6</option>
          <option value="10" {% if ps_a == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_a == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_a == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secAbertos">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secAbertos" class="collapse section-body" data-section-key="secAbertos">
      <!-- Desktop -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70px">#</th>
                <th>Tipo</th>
                <th>Solicitante</th>
                <th>Status</th>
                <th style="width:180px">Criado</th>
                <th>Tratativa</th>
                <th style="width:180px">Anexos</th>
                <th style="width:160px" class="text-center">AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody>
              {% for c in abertos %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.tipo.nome }}</td>
                <td>{{ c.solicitante|default:"â€”" }}</td>
                <td><span class="badge bg-primary">Aberto</span></td>
                <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
                <td class="text-break">{{ c.tratativa_adm|default:"â€”"|truncatechars:120 }}</td>
                <td>
                  {% with files=c.respostas.all %}
                    {% if files %}
                      {% for f in files %}
                        {% if f.valor_arquivo %}
                          <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">ðŸ“Ž {{ forloop.counter }}</a>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  {% endwith %}
                  {% if c.anexo_adm %}
                    <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">ðŸ“Ž Anexo</a>
                  {% endif %}
                </td>
                <td class="text-center">
                  <form method="post" action="{% url 'solicitacoes:assumir_chamado' c.id %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-primary">Assumir</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="8" class="text-muted text-center">Nenhum chamado.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile -->
      <div class="d-md-none p-2">
        {% for c in abertos %}
          <div class="glass p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-primary">Aberto</span>
            </div>
            <div class="small text-muted mt-1">#{{ c.id }} â€¢ {{ c.criado_em|date:"d/m/Y H:i" }}</div>
            <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"â€”" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            {% with files=c.respostas.all %}
              {% if files %}
                <div class="small mt-2">
                  <span class="text-muted">Anexos:</span>
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">ðŸ“Ž {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% if c.anexo_adm %}
              <div class="small mt-2">
                <span class="text-muted">Anexo da tratativa:</span>
                <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">ðŸ“Ž Abrir</a>
              </div>
            {% endif %}
            <form method="post" action="{% url 'solicitacoes:assumir_chamado' c.id %}" class="mt-2">
              {% csrf_token %}
              <button class="btn btn-sm btn-outline-primary w-100">Assumir</button>
            </form>
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>

      {% if abertos.paginator and abertos.paginator.num_pages > 1 %}
      <div class="px-3 py-2">
        <nav aria-label="PaginaÃ§Ã£o â€” Abertos">
          <ul class="pagination pagination-sm mb-0">
            {% if abertos.has_previous %}
              <li class="page-item"><a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ abertos.previous_page_number }}{% else %}?pg_a={{ abertos.previous_page_number }}{% endif %}">Â«</a></li>
            {% endif %}
            {% for i in abertos.paginator.page_range %}
              <li class="page-item {% if abertos.number == i %}active{% endif %}">
                <a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ i }}{% else %}?pg_a={{ i }}{% endif %}">{{ i }}</a>
              </li>
            {% endfor %}
            {% if abertos.has_next %}
              <li class="page-item"><a class="page-link" href="{% if qs_a %}?{{ qs_a }}&pg_a={{ abertos.next_page_number }}{% else %}?pg_a={{ abertos.next_page_number }}{% endif %}">Â»</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>

  {# ---------- Em andamento ---------- #}
  <div class="glass mb-3">
    <div class="section-head andamento collapsed" data-bs-toggle="collapse" data-bs-target="#secAnd" aria-expanded="false" id="headAnd">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Em andamento</h3>
      {% with n=novos.andamento|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ andamento.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por pÃ¡gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_and }}&ps_and='+this.value">
          <option value="2"  {% if ps_and == 2 %}selected{% endif %}>2</option>
          <option value="5"  {% if ps_and == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if ps_and == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_and == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_and == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secAnd">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secAnd" class="collapse section-body" data-section-key="secAnd">
      <!-- Desktop -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70px">#</th>
                <th>Tipo</th>
                <th>Solicitante</th>
                <th>Status</th>
                <th>Atendente</th>
                <th style="width:180px">Criado</th>
                <th>Tratativa</th>
                <th style="width:180px">Anexos</th>
                <th style="width:140px">Gerenciar</th>
              </tr>
            </thead>
            <tbody>
              {% for c in andamento %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.tipo.nome }}</td>
                <td>{{ c.solicitante|default:"â€”" }}</td>
                <td><span class="badge bg-warning text-dark">Em andamento</span></td>
                <td>{{ c.atendente_nome|default:"â€”" }}</td>
                <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
                <td class="text-break">{{ c.tratativa_adm|default:"â€”"|truncatechars:120 }}</td>
                <td>
                  {% with files=c.respostas.all %}
                    {% if files %}
                      {% for f in files %}
                        {% if f.valor_arquivo %}
                          <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">ðŸ“Ž {{ forloop.counter }}</a>
                        {% endif %}
                      {% endfor %}
                    {% else %}<span class="text-muted">â€”</span>{% endif %}
                  {% endwith %}
                  {% if c.anexo_adm %}
                    <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">ðŸ“Ž Tratativa</a>
                  {% endif %}
                </td>
                <td>
                  <a
                    href="{% url 'solicitacoes:gerenciar_chamados' %}?{{ qs_and }}&open={{ c.id }}"
                    class="btn btn-sm btn-outline-primary open-editor"
                    data-id="{{ c.id }}"
                    data-tratativa="{{ c.tratativa_adm|default_if_none:''|escapejs }}"
                  >Editar</a>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="9" class="text-muted text-center">Nenhum chamado.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile -->
      <div class="d-md-none p-2">
        {% for c in andamento %}
          <div class="glass p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-warning text-dark">Em andamento</span>
            </div>
            <div class="small text-muted mt-1">#{{ c.id }} â€¢ {{ c.criado_em|date:"d/m/Y H:i" }}</div>
            <div class="small mt-1"><span class="text-muted">Solicitante:</span> {{ c.solicitante|default:"â€”" }}</div>
            <div class="small mt-1"><span class="text-muted">Atendente:</span> {{ c.atendente_nome|default:"â€”" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            {% with files=c.respostas.all %}
              {% if files %}
                <div class="small mt-2">
                  <span class="text-muted">Anexos:</span>
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">ðŸ“Ž {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% if c.anexo_adm %}
              <div class="small mt-2">
                <span class="text-muted">Anexo da tratativa:</span>
                <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">ðŸ“Ž Abrir</a>
              </div>
            {% endif %}
            <a
              class="btn btn-sm btn-outline-primary w-100 mt-2 open-editor"
              href="{% url 'solicitacoes:gerenciar_chamados' %}?{{ qs_and }}&open={{ c.id }}"
              data-id="{{ c.id }}"
              data-tratativa="{{ c.tratativa_adm|default_if_none:''|escapejs }}"
            >Editar</a>
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>

      {% if andamento.paginator and andamento.paginator.num_pages > 1 %}
      <div class="px-3 py-2">
        <nav aria-label="PaginaÃ§Ã£o â€” Em andamento">
          <ul class="pagination pagination-sm mb-0">
            {% if andamento.has_previous %}
              <li class="page-item"><a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ andamento.previous_page_number }}{% else %}?pg_and={{ andamento.previous_page_number }}{% endif %}">Â«</a></li>
            {% endif %}
            {% for i in andamento.paginator.page_range %}
              <li class="page-item {% if andamento.number == i %}active{% endif %}">
                <a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ i }}{% else %}?pg_and={{ i }}{% endif %}">{{ i }}</a>
              </li>
            {% endfor %}
            {% if andamento.has_next %}
              <li class="page-item"><a class="page-link" href="{% if qs_and %}?{{ qs_and }}&pg_and={{ andamento.next_page_number }}{% else %}?pg_and={{ andamento.next_page_number }}{% endif %}">Â»</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>

{# ---------- Suspensos ---------- #}
<div class="glass mb-5">
  <div class="section-head suspensos collapsed" data-bs-toggle="collapse" data-bs-target="#secSus" aria-expanded="false" id="headSus">
    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
    <h3>Suspensos</h3>
    {% with n=novos.suspensos|default:0 %}
    <span class="counter">
      <span class="num {% if n %}pulse{% endif %}">{{ suspensos.paginator.count }}</span>
      {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
    </span>
    {% endwith %}
    <div class="head-actions">
      <span class="small opacity-75 d-none d-sm-inline">Por pÃ¡gina</span>
      <select class="form-select form-select-sm" onchange="location.href='?{{ qs_sus }}&ps_sus='+this.value">
        <option value="2"  {% if ps_sus == 2 %}selected{% endif %}>2</option>
        <option value="5"  {% if ps_sus == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if ps_sus == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if ps_sus == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if ps_sus == 20 %}selected{% endif %}>20</option>
      </select>
      <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secSus">
        <span class="me-1">Ver mais</span>
        <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      </button>
    </div>
  </div>

  <div id="secSus" class="collapse section-body" data-section-key="secSus">
    <!-- Desktop -->
    <div class="d-none d-md-block">
      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:70px">#</th>
              <th>Tipo</th>
              <th>Solicitante</th>
              <th>Desde</th>
              <th>Tratativa</th>
              <th style="width:160px" class="text-center">AÃ§Ãµes</th>
              <th style="width:180px">Anexos</th>
            </tr>
          </thead>
          <tbody>
            {% for c in suspensos %}
            <tr>
              <td>{{ c.id }}</td>
              <td>{{ c.tipo.nome }}</td>
              <td>{{ c.solicitante|default:"â€”" }}</td>
              <td>{{ c.suspenso_em|date:"d/m/Y H:i"|default:"â€”" }}</td>
              <td class="text-break">{{ c.tratativa_adm|default:"â€”"|truncatechars:120 }}</td>
              <td class="text-center">
                <a
                  class="btn btn-sm btn-outline-primary open-editor"
                  href="{% url 'solicitacoes:gerenciar_chamados' %}?{{ qs_sus }}&open={{ c.id }}"
                  data-id="{{ c.id }}"
                  data-tratativa="{{ c.tratativa_adm|default_if_none:''|escapejs }}"
                >Editar</a>
              </td>
              <td>
                {% with files=c.respostas.all %}
                  {% if files %}
                    {% for f in files %}
                      {% if f.valor_arquivo %}
                        <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">ðŸ“Ž {{ forloop.counter }}</a>
                      {% endif %}
                    {% endfor %}
                  {% else %}<span class="text-muted">â€”</span>{% endif %}
                {% endwith %}
                {% if c.anexo_adm %}
                  <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">ðŸ“Ž Tratativa</a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="text-muted text-center">Nenhum chamado.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile -->
    <div class="d-md-none p-2">
      {% for c in suspensos %}
        <div class="glass p-2 mb-2">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">{{ c.tipo.nome }}</div>
            <span class="badge rounded-pill bg-danger">Suspenso</span>
          </div>
          <div class="small text-muted mt-1">#{{ c.id }} â€¢ Desde {{ c.suspenso_em|date:"d/m/Y H:i"|default:"â€”" }}</div>
          {% if c.tratativa_adm %}<div class="small mt-1"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
          {% with files=c.respostas.all %}
            {% if files %}
              <div class="small mt-2">
                <span class="text-muted">Anexos:</span>
                {% for f in files %}
                  {% if f.valor_arquivo %}
                    <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">ðŸ“Ž {{ forloop.counter }}</a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          {% if c.anexo_adm %}
            <div class="small mt-2">
              <span class="text-muted">Anexo da tratativa:</span>
              <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">ðŸ“Ž Abrir</a>
            </div>
          {% endif %}
          <a
            class="btn btn-sm btn-outline-primary w-100 mt-2 open-editor"
            href="{% url 'solicitacoes:gerenciar_chamados' %}?{{ qs_sus }}&open={{ c.id }}"
            data-id="{{ c.id }}"
            data-tratativa="{{ c.tratativa_adm|default_if_none:''|escapejs }}"
          >Editar</a>
        </div>
      {% empty %}
        <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
      {% endfor %}
    </div>

    {% if suspensos.paginator and suspensos.paginator.num_pages > 1 %}
    <div class="px-3 pb-2">
      <nav aria-label="PaginaÃ§Ã£o â€” Suspensos">
        <ul class="pagination pagination-sm mb-0">
          {% if suspensos.has_previous %}
            <li class="page-item"><a class="page-link" href="{% if qs_sus %}?{{ qs_sus }}&pg_sus={{ suspensos.previous_page_number }}{% else %}?pg_sus={{ suspensos.previous_page_number }}{% endif %}">Â«</a></li>
          {% endif %}
          {% for i in suspensos.paginator.page_range %}
            <li class="page-item {% if suspensos.number == i %}active{% endif %}">
              <a class="page-link" href="{% if qs_sus %}?{{ qs_sus }}&pg_sus={{ i }}{% else %}?pg_sus={{ i }}{% endif %}">{{ i }}</a>
            </li>
          {% endfor %}
          {% if suspensos.has_next %}
            <li class="page-item"><a class="page-link" href="{% if qs_sus %}?{{ qs_sus }}&pg_sus={{ suspensos.next_page_number }}{% else %}?pg_sus={{ suspensos.next_page_number }}{% endif %}">Â»</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

  <!-- ===================== QUADRANTE INFERIOR ===================== -->
  <h2 class="quad-title">HistÃ³rico</h2>

  {# ---------- ConcluÃ­dos ---------- #}
  <div class="glass mb-3">
    <div class="section-head concluidos collapsed" data-bs-toggle="collapse" data-bs-target="#secCon" aria-expanded="false" id="headCon">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>ConcluÃ­dos</h3>
      {% with n=novos.concluidos|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ concluidos.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por pÃ¡gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_con }}&ps_con='+this.value">
          <option value="2"  {% if ps_con == 2 %}selected{% endif %}>2</option>
          <option value="5"  {% if ps_con == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if ps_con == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_con == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_con == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secCon">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secCon" class="collapse section-body" data-section-key="secCon">
      <!-- Desktop -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70px">#</th>
                <th>Tipo</th>
                <th>Solicitante</th>
                <th>Status</th>
                <th style="width:180px">Criado</th>
                <th>Tratativa</th>
                <th style="width:180px">Anexos</th>
              </tr>
            </thead>
            <tbody>
              {% for c in concluidos %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.tipo.nome }}</td>
                <td>{{ c.solicitante|default:"â€”" }}</td>
                <td><span class="badge bg-success">ConcluÃ­do</span></td>
                <td>
                  {{ c.criado_em|date:"d/m/Y H:i" }}<br>
                  <small class="text-muted">Atualizado: {{ c.atualizado_em|date:"d/m/Y H:i" }}</small>
                </td>
                <td class="text-break">{{ c.tratativa_adm|default:"â€”"|truncatechars:120 }}</td>
                <td>
                  {% with files=c.respostas.all %}
                    {% if files %}
                      {% for f in files %}
                        {% if f.valor_arquivo %}
                          <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">ðŸ“Ž {{ forloop.counter }}</a>
                        {% endif %}
                      {% endfor %}
                    {% else %}<span class="text-muted">â€”</span>{% endif %}
                  {% endwith %}
                  {% if c.anexo_adm %}
                    <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">ðŸ“Ž Tratativa</a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-muted text-center">Nenhum chamado.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile -->
      <div class="d-md-none p-2">
        {% for c in concluidos %}
          <div class="glass p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-success">ConcluÃ­do</span>
            </div>
            <div class="small text-muted mt-1">
              #{{ c.id }} â€¢ {{ c.criado_em|date:"d/m/Y H:i" }}<br>
              Atualizado: {{ c.atualizado_em|date:"d/m/Y H:i" }}
            </div>
            {% if c.tratativa_adm %}<div class="small mt-1"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            {% with files=c.respostas.all %}
              {% if files %}
                <div class="small mt-2">
                  <span class="text-muted">Anexos:</span>
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">ðŸ“Ž {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% if c.anexo_adm %}
              <div class="small mt-2">
                <span class="text-muted">Anexo da tratativa:</span>
                <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">ðŸ“Ž Abrir</a>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>

      {% if concluidos.paginator and concluidos.paginator.num_pages > 1 %}
      <div class="px-3 py-2">
        <nav aria-label="PaginaÃ§Ã£o â€” ConcluÃ­dos">
          <ul class="pagination pagination-sm mb-0">
            {% if concluidos.has_previous %}
              <li class="page-item"><a class="page-link" href="{% if qs_con %}?{{ qs_con }}&pg_con={{ concluidos.previous_page_number }}{% else %}?pg_con={{ concluidos.previous_page_number }}{% endif %}">Â«</a></li>
            {% endif %}
            {% for i in concluidos.paginator.page_range %}
              <li class="page-item {% if concluidos.number == i %}active{% endif %}">
                <a class="page-link" href="{% if qs_con %}?{{ qs_con }}&pg_con={{ i }}{% else %}?pg_con={{ i }}{% endif %}">{{ i }}</a>
              </li>
            {% endfor %}
            {% if concluidos.has_next %}
              <li class="page-item"><a class="page-link" href="{% if qs_con %}?{{ qs_con }}&pg_con={{ concluidos.next_page_number }}{% else %}?pg_con={{ concluidos.next_page_number }}{% endif %}">Â»</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>

  {# ---------- Cancelados ---------- #}
  <div class="glass">
    <div class="section-head cancelados collapsed" data-bs-toggle="collapse" data-bs-target="#secCan" aria-expanded="false" id="headCan">
      <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
      <h3>Cancelados</h3>
      {% with n=novos.cancelados|default:0 %}
      <span class="counter">
        <span class="num {% if n %}pulse{% endif %}">{{ cancelados.paginator.count }}</span>
        {% if n %}<small class="opacity-75">+{{ n }} novo(s)</small>{% endif %}
      </span>
      {% endwith %}
      <div class="head-actions">
        <span class="small opacity-75 d-none d-sm-inline">Por pÃ¡gina</span>
        <select class="form-select form-select-sm" onchange="location.href='?{{ qs_can }}&ps_can='+this.value">
          <option value="2"  {% if ps_can == 2 %}selected{% endif %}>2</option>
          <option value="5"  {% if ps_can == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if ps_can == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if ps_can == 15 %}selected{% endif %}>15</option>
          <option value="20" {% if ps_can == 20 %}selected{% endif %}>20</option>
        </select>
        <button class="btn btn-soft btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#secCan">
          <span class="me-1">Ver mais</span>
          <svg class="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8.12 9.29 12 13.17l3.88-3.88 1.41 1.41L12 16l-5.29-5.29z"/></svg>
        </button>
      </div>
    </div>

    <div id="secCan" class="collapse section-body" data-section-key="secCan">
      <!-- Desktop -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70px">#</th>
                <th>Tipo</th>
                <th>Solicitante</th>
                <th>Status</th>
                <th style="width:180px">Criado</th>
                <th>Tratativa</th>
                <th style="width:180px">Anexos</th>
              </tr>
            </thead>
            <tbody>
              {% for c in cancelados %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.tipo.nome }}</td>
                <td>{{ c.solicitante|default:"â€”" }}</td>
                <td><span class="badge bg-dark">Cancelado</span></td>
                <td>{{ c.criado_em|date:"d/m/Y H:i" }}</td>
                <td class="text-break">{{ c.tratativa_adm|default:"â€”"|truncatechars:120 }}</td>
                <td>
                  {% with files=c.respostas.all %}
                    {% if files %}
                      {% for f in files %}
                        {% if f.valor_arquivo %}
                          <a href="{{ f.valor_arquivo.url }}" class="btn btn-outline-secondary btn-sm me-1" target="_blank" title="{{ f.pergunta.texto|default:'Anexo' }}">ðŸ“Ž {{ forloop.counter }}</a>
                        {% endif %}
                      {% endfor %}
                    {% else %}<span class="text-muted">â€”</span>{% endif %}
                  {% endwith %}
                  {% if c.anexo_adm %}
                    <a href="{{ c.anexo_adm.url }}" class="btn btn-outline-dark btn-sm mt-1" target="_blank" title="Anexo da tratativa">ðŸ“Ž Tratativa</a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-muted text-center">Nenhum chamado.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile -->
      <div class="d-md-none p-2">
        {% for c in cancelados %}
          <div class="glass p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.tipo.nome }}</div>
              <span class="badge rounded-pill bg-dark">Cancelado</span>
            </div>
            <div class="small text-muted mt-1">#{{ c.id }} â€¢ {{ c.criado_em|date:"d/m/Y H:i" }}</div>
            {% if c.tratativa_adm %}<div class="small mt-1"><span class="text-muted">Tratativa:</span> {{ c.tratativa_adm|truncatechars:90 }}</div>{% endif %}
            {% with files=c.respostas.all %}
              {% if files %}
                <div class="small mt-2">
                  <span class="text-muted">Anexos:</span>
                  {% for f in files %}
                    {% if f.valor_arquivo %}
                      <a href="{{ f.valor_arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-1 mt-1">ðŸ“Ž {{ forloop.counter }}</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% if c.anexo_adm %}
              <div class="small mt-2">
                <span class="text-muted">Anexo da tratativa:</span>
                <a href="{{ c.anexo_adm.url }}" target="_blank" class="btn btn-sm btn-outline-dark ms-1 mt-1">ðŸ“Ž Abrir</a>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div class="p-3 text-center text-muted small">Nenhum chamado.</div>
        {% endfor %}
      </div>

      {% if cancelados.paginator and cancelados.paginator.num_pages > 1 %}
      <div class="px-3 py-2">
        <nav aria-label="PaginaÃ§Ã£o â€” Cancelados">
          <ul class="pagination pagination-sm mb-0">
            {% if cancelados.has_previous %}
              <li class="page-item"><a class="page-link" href="{% if qs_can %}?{{ qs_can }}&pg_can={{ cancelados.previous_page_number }}{% else %}?pg_can={{ cancelados.previous_page_number }}{% endif %}">Â«</a></li>
            {% endif %}
            {% for i in cancelados.paginator.page_range %}
              <li class="page-item {% if cancelados.number == i %}active{% endif %}">
                <a class="page-link" href="{% if qs_can %}?{{ qs_can }}&pg_can={{ i }}{% else %}?pg_can={{ i }}{% endif %}">{{ i }}</a>
              </li>
            {% endfor %}
            {% if cancelados.has_next %}
              <li class="page-item"><a class="page-link" href="{% if qs_can %}?{{ qs_can }}&pg_can={{ cancelados.next_page_number }}{% else %}?pg_can={{ cancelados.next_page_number }}{% endif %}">Â»</a></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>

</div>  {# /container #}

{# ===================== MODAL DE EDIÃ‡ÃƒO ===================== #}
<div class="modal fade" id="modalEditarChamado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <form id="formEditarChamado" method="post" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Editar Chamado <span id="edt-id" class="text-muted"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Tratativa</label>
          <textarea name="tratativa_adm" id="edt-tratativa" class="form-control" rows="4" placeholder="Descreva a tratativa..."></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Anexo da tratativa (opcional)</label>
          <input type="file" name="anexo_adm" class="form-control">
          <div class="form-text">PDF, imagens, etc.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Motivo (apenas para suspender/cancelar)</label>
          <select name="motivo" class="form-select">
            <option value="">â€” Selecione â€”</option>
            <option>Chamado nÃ£o procede</option>
            <option>Chamado errado</option>
            <option>Chamado de teste</option>
            <option>Chamado perdido</option>
            <option>Outros</option>
          </select>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="d-flex gap-2">
          <button type="submit" name="acao" value="salvar" class="btn btn-secondary">Salvar</button>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" name="acao" value="suspender" class="btn btn-warning">Suspender</button>
          <button type="submit" name="acao" value="cancelar"  class="btn btn-dark">Cancelar</button>
          <button type="submit" name="acao" value="concluir"  class="btn btn-success">Concluir</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ===== CSRF helpers ===== */
function getCookie(name){
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
function getCsrfToken(){
  // 1) cookie padrÃ£o do Django
  const fromCookie = getCookie('csrftoken');
  if (fromCookie && fromCookie.length >= 32) return fromCookie;
  // 2) qualquer input hidden renderizado por {% csrf_token %}
  const fromInput = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
  if (fromInput && fromInput.length >= 32) return fromInput;
  return null;
}

/* ===== Memoriza estado + marca seÃ§Ã£o vista ===== */
(function () {
  const hasBootstrap = typeof window.bootstrap?.Collapse === 'function';

  function marcarVisto(secao) {
    if (!secao) return;
    const token = getCsrfToken();
    if (!token) return;

    fetch("{% url 'solicitacoes:marcar_secao_vista' %}", {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "X-CSRFToken": token
      },
      body: "secao=" + encodeURIComponent(secao)
    }).catch(()=>{});
  }

  document.querySelectorAll('.collapse.section-body').forEach(function (el) {
    const secKey = el.dataset.sectionKey || el.id || 'sec';
    const key = 'tratativa:' + secKey;
    const saved = localStorage.getItem(key);

    if (saved === 'open' && hasBootstrap) {
      try { new bootstrap.Collapse(el, { toggle: true }); } catch(e){}
    }

    el.addEventListener('shown.bs.collapse', function(){
      localStorage.setItem(key, 'open');
      const headBtn = document.querySelector('[data-bs-target="#' + el.id + '"]');
      if (headBtn){
        headBtn.classList.remove('collapsed');
        headBtn.querySelector('.num')?.classList.remove('pulse');
      }
      const map = {secAbertos:"abertos", secAnd:"andamento", secSus:"suspensos", secCon:"concluidos", secCan:"cancelados"};
      marcarVisto(map[secKey]);
    });

    el.addEventListener('hidden.bs.collapse', function(){
      localStorage.setItem(key, 'closed');
      const headBtn = document.querySelector('[data-bs-target="#' + el.id + '"]');
      headBtn?.classList.add('collapsed');
    });
  });
})();

/* ===== Modal Editar ===== */
(function(){
  const modalEl = document.getElementById('modalEditarChamado');
  const form    = document.getElementById('formEditarChamado');
  const spanId  = document.getElementById('edt-id');
  const txtTrat = document.getElementById('edt-tratativa');

  if (!modalEl || !form || !spanId || !txtTrat || typeof window.bootstrap?.Modal !== 'function') {
    return; // pÃ¡gina sem modal ou Bootstrap indisponÃ­vel
  }

  const modal = new bootstrap.Modal(modalEl);

  function setFormAction(id){
    form.action = `/solicitacoes/chamados/${id}/tratar/`;
  }
  function openEditor(id, tratativa = ""){
    setFormAction(id);
    spanId.textContent = `#${id}`;
    txtTrat.value = tratativa || "";
    modal.show();
  }

  document.querySelectorAll('.open-editor').forEach(btn=>{
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const id = this.dataset.id;
      const tr = this.dataset.tratativa || "";
      if (!id) return;
      openEditor(id, tr);
      try {
        const url = new URL(window.location.href);
        url.searchParams.set('open', id);
        history.replaceState({}, "", url);
      } catch (_e) {}
    });
  });

  // Se veio ?open=ID, abre o modal correspondente
  try {
    const params = new URLSearchParams(window.location.search);
    const openId = params.get('open');
    if (openId) {
      const trigger = document.querySelector('.open-editor[data-id="' + openId + '"]');
      const tr = trigger ? (trigger.dataset.tratativa || "") : "";
      openEditor(openId, tr);
    }
  } catch (_e) {}
})();
</script>
{% endblock %}
