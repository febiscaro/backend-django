{% load static %}

<!-- NAVBAR RESPONSIVA (Bootstrap 5) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm" aria-label="Barra de navegaÃ§Ã£o principal">
  <div class="container-fluid">
    <!-- Brand leva para a Home -->
    <a class="navbar-brand fw-bold" href="/">Enprodes Sys</a>

    <!-- BotÃ£o hamburguer (abre o offcanvas no mobile) -->
    <button class="navbar-toggler" type="button"
            data-bs-toggle="offcanvas" data-bs-target="#mainNavOffcanvas"
            aria-controls="mainNavOffcanvas" aria-label="Abrir menu de navegaÃ§Ã£o">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Offcanvas (mobile) / ConteÃºdo inline (â‰¥ lg) -->
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="mainNavOffcanvas" aria-labelledby="mainNavOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainNavOffcanvasLabel">Enprodes Sys</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>

      <div class="offcanvas-body d-flex flex-lg-row flex-column">
        <!-- Bloco ESQUERDO: navegaÃ§Ã£o -->
        <ul class="navbar-nav me-lg-auto mb-2 mb-lg-0">

          {% if request.user.is_authenticated %}
            <!-- Dropdown: Chamados -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle {% if 'solicitacoes' in request.path %}active{% endif %}"
                 href="#" id="menuChamados" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Chamados
              </a>
              <ul class="dropdown-menu" aria-labelledby="menuChamados">

                {# Meus Chamados: todos, exceto perfil ADMIN (superuser pode ver tudo) #}
                {% if request.user.is_superuser or request.user.perfil != 'ADMIN' %}
                <li>
                  <a class="dropdown-item {% if 'solicitacoes/meus-chamados' in request.path %}active{% endif %}"
                     href="{% url 'solicitacoes:meus_chamados' %}">
                    Meus Chamados
                  </a>
                </li>
                {% endif %}

                {# Atendimento de Chamados: apenas ADMIN ou superuser #}
                {% if request.user.is_superuser or request.user.perfil == 'ADMIN' %}
                <li>
                  <a class="dropdown-item {% if 'solicitacoes/atendimento' in request.path %}active{% endif %}"
                     href="{% url 'solicitacoes:gerenciar_chamados' %}">
                    Atendimento de Chamados
                  </a>
                </li>
                {% endif %}

                {# Tipos de Chamados (Modelos): somente superuser #}
                {% if request.user.is_superuser %}
                <li>
                  <a class="dropdown-item {% if 'solicitacoes/tipos' in request.path %}active{% endif %}"
                     href="{% url 'solicitacoes:tipos_list' %}">
                    Tipos de Chamados
                  </a>
                </li>
                {% endif %}

              </ul>
            </li>
          {% endif %}

          <!-- Dropdown: Admin (somente superuser) -->
          {% if request.user.is_authenticated and request.user.is_superuser %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle
                        {% if request.path|slice:':7' == '/admin/' or 'accounts' in request.path %}active{% endif %}"
                 href="#" id="menuAdmin" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="menuAdmin">
                <li>
                  <a class="dropdown-item {% if request.path|slice:':7' == '/admin/' %}active{% endif %}"
                     href="/admin/">
                    Django Admin
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if 'accounts' in request.path %}active{% endif %}"
                     href="{% url 'accounts:dashboard' %}">
                    UsuÃ¡rios
                  </a>
                </li>
              </ul>
            </li>
          {% endif %}
        </ul>

        <!-- Bloco DIREITO: notificaÃ§Ãµes + usuÃ¡rio -->
        <ul class="navbar-nav ms-lg-auto">
          {% if request.user.is_authenticated %}
            <!-- ðŸ”” Sininho de NotificaÃ§Ãµes -->
            <li class="nav-item dropdown me-2">
              <a class="nav-link position-relative" href="#" id="notifDropdown" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false"
                 hx-get="{% url 'notifications:dropdown' %}"
                 hx-trigger="click"
                 hx-target="#notifMenu"
                 hx-swap="innerHTML">
                ðŸ””
                <span id="notifBadge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      style="display:none">0</span>
              </a>
              <div id="notifMenu" class="dropdown-menu dropdown-menu-end"></div>
            </li>

            <!-- UsuÃ¡rio -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userMenu" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false">
                <span class="me-2">OlÃ¡,</span>
                <strong>{% firstof request.user.get_full_name request.user.nome_completo request.user.cpf "usuÃ¡rio" %}</strong>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                <li><a class="dropdown-item" href="{% url 'accounts:perfil' %}">Meu perfil</a></li>
                <li><a class="dropdown-item" href="{% url 'password_change' %}">Trocar senha</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{% url 'logout' %}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning w-100">Sair</button>
                  </form>
                </li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="btn btn-primary btn-sm ms-lg-2" href="{% url 'login' %}">Entrar</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
  async function refreshNotifCount() {
    try {
      const r = await fetch("{% url 'notifications:count' %}", {credentials:'same-origin'});
      const data = await r.json();
      const el = document.getElementById('notifBadge');
      if (data.count > 0) {
        el.textContent = data.count;
        el.style.display = 'inline-block';
      } else {
        el.style.display = 'none';
      }
    } catch(e) { /* silencioso */ }
  }
  refreshNotifCount();
  setInterval(refreshNotifCount, 15000); // atualiza a cada 15s
</script>
