{% load static %}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm" aria-label="Barra de navega√ß√£o principal">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="/">EnprodeSys</a>

    <button class="navbar-toggler" type="button"
            data-bs-toggle="offcanvas" data-bs-target="#mainNavOffcanvas"
            aria-controls="mainNavOffcanvas" aria-label="Abrir menu de navega√ß√£o">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="mainNavOffcanvas" aria-labelledby="mainNavOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainNavOffcanvasLabel">EnprodeSys</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>

      <div class="offcanvas-body d-flex flex-lg-row flex-column">
        <ul class="navbar-nav me-lg-auto mb-2 mb-lg-0">

          {% if request.user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle {% if 'solicitacoes' in request.path and 'relatorio' not in request.path %}active{% endif %}"
                 href="#" id="menuChamados" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Chamados
              </a>

              <ul class="dropdown-menu" aria-labelledby="menuChamados">
                {% with p=request.user.perfil %}

                  {# SUPERUSER: v√™ tudo (ambos os itens) #}
                  {% if request.user.is_superuser %}
                    <li>
                      <a class="dropdown-item {% if 'solicitacoes/meus-chamados' in request.path %}active{% endif %}"
                         href="{% url 'solicitacoes:meus_chamados' %}">
                        Meus Chamados
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item {% if 'solicitacoes/atendimento' in request.path %}active{% endif %}"
                         href="{% url 'solicitacoes:gerenciar_chamados' %}">
                        Atendimento de Chamados
                      </a>
                    </li>

                  {# ADMIN (aceita ADMINISTRADOR/ADMINISTRATIVO): somente Atendimento #}
                  {% elif p == 'ADMINISTRADOR' or p == 'ADMINISTRATIVO' %}
                    <li>
                      <a class="dropdown-item {% if 'solicitacoes/atendimento' in request.path %}active{% endif %}"
                         href="{% url 'solicitacoes:gerenciar_chamados' %}">
                        Atendimento de Chamados
                      </a>
                    </li>

                  {# GESTOR e COLABORADOR: somente Meus Chamados #}
                  {% elif p == 'GESTOR' or p == 'COLABORADOR' %}
                    <li>
                      <a class="dropdown-item {% if 'solicitacoes/meus-chamados' in request.path %}active{% endif %}"
                         href="{% url 'solicitacoes:meus_chamados' %}">
                        Meus Chamados
                      </a>
                    </li>
                  {% endif %}

                {% endwith %}

                {# Tipos de Chamados: s√≥ superuser #}
                {% if request.user.is_superuser %}
                  <li>
                    <a class="dropdown-item {% if 'solicitacoes/tipos' in request.path %}active{% endif %}"
                       href="{% url 'solicitacoes:tipos_list' %}">
                      Tipos de Chamados
                    </a>
                  </li>
                {% endif %}
              </ul>
            </li>

            {# ==== NOVO MENU: PROJETOS ==== #}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle
                        {% if 'projetos/centros' in request.path or 'projetos/minhas' in request.path %}active{% endif %}"
                 href="#" id="menuProjetos" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Projetos
              </a>
              <ul class="dropdown-menu" aria-labelledby="menuProjetos">

                {# CC (Centros de Custo) ‚Äî vis√≠vel para SUPERUSER ou GESTOR #}
                {% if request.user.is_superuser or request.user.perfil == 'GESTOR' %}
                  <li>
                    <a class="dropdown-item {% if 'projetos/centros' in request.path %}active{% endif %}"
                       href="{% url 'projetos:centros_list' %}">
                      CC (Centros de Custo)
                    </a>
                  </li>

                  {# Gest√£o ‚Äî apontando para a lista de CC; o board abre ao clicar no centro #}
                  <li>
                    <a class="dropdown-item {% if 'projetos/centros' in request.path %}active{% endif %}"
                       href="{% url 'projetos:centros_list' %}">
                      Gest√£o
                    </a>
                  </li>

                  <li><hr class="dropdown-divider"></li>
                {% endif %}

                {# Minhas Tarefas ‚Äî qualquer usu√°rio logado #}
                <li>
                  <a class="dropdown-item {% if 'projetos/minhas' in request.path %}active{% endif %}"
                     href="#"
                     title="Em breve: suas tarefas liberadas para execu√ß√£o">
                    Minhas Tarefas
                  </a>
                </li>
              </ul>
            </li>

            {# ==== NOVO MENU: RELAT√ìRIOS (superusu√°rio OU gestor) ==== #}
            {% if request.user.is_superuser or request.user.perfil == 'GESTOR' %}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle {% if 'solicitacoes/relatorio' in request.path %}active{% endif %}"
                   href="#" id="menuRelatorios" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Relat√≥rios
                </a>
                <ul class="dropdown-menu" aria-labelledby="menuRelatorios">
                  <li>
                    <a class="dropdown-item {% if 'solicitacoes/relatorio' in request.path %}active{% endif %}"
                       href="{% url 'solicitacoes:relatorio_solicitacoes' %}">
                      Solicita√ß√µes
                    </a>
                  </li>
                </ul>
              </li>
            {% endif %}

          {% endif %}

          {% if request.user.is_authenticated and request.user.is_superuser %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle
                        {% if request.path|slice:':7' == '/admin/' or 'accounts' in request.path %}active{% endif %}"
                 href="#" id="menuAdmin" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="menuAdmin">
                <li>
                  <a class="dropdown-item {% if request.path|slice:':7' == '/admin/' %}active{% endif %}"
                     href="/admin/">
                    Django Admin
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if 'accounts' in request.path %}active{% endif %}"
                     href="{% url 'accounts:dashboard' %}">
                    Usu√°rios
                  </a>
                </li>
              </ul>
            </li>
          {% endif %}
        </ul>

        <ul class="navbar-nav ms-lg-auto">
          {% if request.user.is_authenticated %}
            <li class="nav-item dropdown me-2">
              <a class="nav-link position-relative" href="#" id="notifDropdown" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false"
                 hx-get="{% url 'notifications:dropdown' %}"
                 hx-trigger="click"
                 hx-target="#notifMenu"
                 hx-swap="innerHTML">
                üîî
                <span id="notifBadge"
                      class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      style="display:none">0</span>
              </a>
              <div id="notifMenu" class="dropdown-menu dropdown-menu-end"></div>
            </li>

            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userMenu" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false">
                <span class="me-2">Ol√°,</span>
                <strong>{% firstof request.user.get_full_name request.user.nome_completo request.user.cpf "usu√°rio" %}</strong>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                <li><a class="dropdown-item" href="{% url 'accounts:perfil' %}">Meu perfil</a></li>
                <li><a class="dropdown-item" href="{% url 'password_change' %}">Trocar senha</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{% url 'logout' %}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning w-100">Sair</button>
                  </form>
                </li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="btn btn-primary btn-sm ms-lg-2" href="{% url 'login' %}">Entrar</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
  async function refreshNotifCount() {
    try {
      const r = await fetch("{% url 'notifications:count' %}", {credentials:'same-origin'});
      const data = await r.json();
      const el = document.getElementById('notifBadge');
      if (data.count > 0) {
        el.textContent = data.count;
        el.style.display = 'inline-block';
      } else {
        el.style.display = 'none';
      }
    } catch(e) { /* silencioso */ }
  }
  refreshNotifCount();
  setInterval(refreshNotifCount, 15000);
</script>
