{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Enprodes Sys{% endblock %}</title>

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Títulos das seções em "Meus Chamados" */
    .header-abertos   { background:#176290; color:#ffffff; }
    .header-andamento { background:#FCD773; color:#212529; }
    .header-suspensos { background:#8F1222; color:#ffffff; }
    .header-concluidos{ background:#0D8482; color:#ffffff; }
    .header-cancelados{ background:#212822; color:#ffffff; }

    .card-header { border-radius:.5rem .5rem 0 0; }

    /* Mensagens fixas no topo */
    .flash-wrap{
      position: sticky;
      top: 0;
      z-index: 1080;
    }
  </style>

  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  {% block extra_css %}{% endblock %}
</head>

<body class="bg-body-tertiary">
  {% if user.is_authenticated %}
    {% include "includes/_navbar.html" %}
  {% endif %}

  {# ==== MENSAGENS ==== #}
  {% if messages %}
    <div class="flash-wrap container mt-3">
      {% for message in messages %}
        {% with tags=message.tags %}
          {% if 'error' in tags %}
            <div class="alert alert-danger alert-dismissible fade show shadow-sm d-flex align-items-center gap-2" role="alert">
              <strong class="me-1">Erro:</strong>
              <span>{{ message }}</span>
              <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% elif 'warning' in tags %}
            <div class="alert alert-warning alert-dismissible fade show shadow-sm d-flex align-items-center gap-2" role="alert">
              <strong class="me-1">Atenção:</strong>
              <span>{{ message }}</span>
              <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% elif 'success' in tags %}
            <div class="alert alert-success alert-dismissible fade show shadow-sm d-flex align-items-center gap-2" role="alert">
              <strong class="me-1">Pronto:</strong>
              <span>{{ message }}</span>
              <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% else %}
            <div class="alert alert-info alert-dismissible fade show shadow-sm d-flex align-items-center gap-2" role="alert">
              <strong class="me-1">Aviso:</strong>
              <span>{{ message }}</span>
              <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}
  {# ==== /MENSAGENS ==== #}

  <main class="container py-4">
    {% block content %}{% endblock %}
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <!-- CSRF para HTMX via cookie -->
  <script>
    (function () {
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      document.addEventListener('htmx:configRequest', function (e) {
        const token = getCookie('csrftoken');
        if (token) e.detail.headers['X-CSRFToken'] = token;
      });
    })();
  </script>

  <!-- Auto-fecha as alerts depois de 4s (opcional) -->
  <script>
    setTimeout(function () {
      document.querySelectorAll('.alert').forEach(function (el) {
        try { bootstrap.Alert.getOrCreateInstance(el).close(); } catch (e) {}
      });
    }, 4000);
  </script>

  <!-- Proteção global: double-submit + token idem -->
  <script>
    (function () {
      function rndHex(bytes = 16) {
        if (window.crypto && crypto.getRandomValues) {
          const a = new Uint8Array(bytes);
          crypto.getRandomValues(a);
          return Array.from(a, b => ('0' + b.toString(16)).slice(-2)).join('');
        }
        return (Date.now().toString(36) + Math.random().toString(36).slice(2));
      }

      document.addEventListener('submit', function (ev) {
        const form = ev.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (!form.matches('form[data-submit-once]')) return;

        // já submetido? cancela
        if (form.dataset.submitted === '1') {
          ev.preventDefault();
          return false;
        }
        form.dataset.submitted = '1';

        // injeta token idem (se a view usar)
        if (!form.querySelector('input[name="idem"]')) {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'idem';
          hidden.value = rndHex(16);
          form.appendChild(hidden);
        }

        // desabilita botões e mostra feedback
        const submits = form.querySelectorAll('button[type="submit"], input[type="submit"]');
        submits.forEach(btn => {
          btn.disabled = true;
          if (btn.tagName === 'BUTTON') {
            btn.dataset.originalHtml = btn.innerHTML;
            btn.innerHTML = 'Enviando…';
          }
        });
      });
    })();
  </script>

  <script src="{% static 'js/app.js' %}"></script>
  {% block extra_js %}{% endblock %}
</body>
</html>
